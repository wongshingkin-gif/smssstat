<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šè©•åˆ†ç³»çµ±</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 15px; margin-left: 5px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background-color: #4CAF50; }
        .btn-sub { background-color: #f44336; }
        #status { color: #888; margin-bottom: 15px; }
    </style>
</head>
<body>

    <h2>ğŸ“ ç­ç´šè©•åˆ†ç³»çµ±</h2>
    <div id="status">è³‡æ–™è¼‰å…¥ä¸­...</div>
    <div id="student-list"></div>

    <script>
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
        const GAS_URL = "YOUR_GAS_URL_HERE"; 

        // è¨»å†Š Service Worker (PWA çš„æ ¸å¿ƒ)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(() => console.log("Service Worker è¨»å†ŠæˆåŠŸ"))
            .catch(err => console.log("Service Worker è¨»å†Šå¤±æ•—", err));
        }

        // å–å¾—å­¸ç”Ÿåå–®
        async function loadData() {
            document.getElementById("status").innerText = "è³‡æ–™è¼‰å…¥ä¸­...";
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                renderList(data);
                document.getElementById("status").innerText = "è³‡æ–™å·²æ›´æ–°";
            } catch (error) {
                document.getElementById("status").innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
            }
        }

        // æ¸²æŸ“ç•«é¢
        function renderList(students) {
            const listDiv = document.getElementById("student-list");
            listDiv.innerHTML = ""; 
            students.forEach(student => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
                    <div>
                        <strong>${student.n}</strong> (å­¸è™Ÿ: ${student.id}) <br>
                        <span style="color:#ff9800; font-size:1.2em;">åˆ†æ•¸: <span id="score-${student.id}">${student.s}</span></span>
                    </div>
                    <div>
                        <button class="btn btn-add" onclick="updateScore('${student.id}', 1)">+1</button>
                        <button class="btn btn-sub" onclick="updateScore('${student.id}', -1)">-1</button>
                    </div>
                `;
                listDiv.appendChild(card);
            });
        }

        // åŠ åˆ†/æ‰£åˆ†å‹•ä½œ
        function updateScore(id, change) {
            const scoreElement = document.getElementById(`score-${id}`);
            let currentScore = parseInt(scoreElement.innerText);
            let newScore = currentScore + change;
            
            // ç•«é¢å…ˆå³æ™‚æ›´æ–° (æå‡ä½¿ç”¨è€…é«”é©—)
            scoreElement.innerText = newScore;
            document.getElementById("status").innerText = "å„²å­˜ä¸­...";

            // å¯„é€è³‡æ–™åˆ°å¾Œå°
            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ id: id, score: newScore }),
                // ä½¿ç”¨ no-cors é¿å…è·¨åŸŸé˜»æ“‹å•é¡Œï¼Œé›–ç„¶æ”¶ä¸åˆ°å®Œæ•´ responseï¼Œä½†èƒ½æˆåŠŸé€å‡º
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" }
            }).then(() => {
                document.getElementById("status").innerText = "å„²å­˜æˆåŠŸ";
            }).catch(() => {
                document.getElementById("status").innerText = "å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦";
                scoreElement.innerText = currentScore; // å¤±æ•—å‰‡é€€å›åŸåˆ†æ•¸
            });
        }

        // ç¶²é è¼‰å…¥æ™‚ç«‹åˆ»åŸ·è¡Œ
        window.onload = loadData;
    </script>
</body>
</html>